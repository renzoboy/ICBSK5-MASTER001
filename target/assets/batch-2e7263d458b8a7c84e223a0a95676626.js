new Vue({el:"#batch",data:{transactions:[],batchDetails:[],transaction:"",newCurrency:"1",totalCredit:0,totalDebit:0,newAccount:"",newAmount:"",newPrincipal:"",newInterest:"",newPenalty:"",newServiceCharge:"",breakdown:!1,lineNo:0,newLineNo:0,newDebit:"",newCredit:"",newCreditAccount:"",newDebitAccount:"",url:"",newBatchId:(new Date).getTime().toString(),newValueDate:"",newBatchName:"",transactionParticulars:"",transactionReference:"",branch:"",glAccountList:[],loanAccountList:[],depositAccountList:[],newLoans:"",newTemplate:"1",checkNo:"",glName:""},computed:{},methods:{addTransaction:function(e){if(e.preventDefault(),console.log(e),this.newAccount=$("#glBatchAccountHidden").val(),(9==this.transaction||10==this.transaction)&&(console.log("pasok sa txn 9"),this.newAmount=$("#apamount").val()),console.log("New Account:"+this.newAccount),console.log("Txn Type:"+this.transaction),console.log("New Amount:"+this.newAmount),!this.transaction||!this.newAccount||!this.newAmount)return void alert("Please check the fields");if(this.newAmount=this.newAmount.toString(),this.newAmount=parseFloat(this.newAmount.replace(/,/g,"")),this.breakdown){this.newInterest?0==this.newInterest?this.newInterest=0:(this.newInterest=this.newInterest.toString(),this.newInterest=parseFloat(this.newInterest.replace(/,/g,""))):this.newInterest=0,this.newPenalty?0==this.newPenalty?this.newPenalty=0:(this.newPenalty=this.newPenalty.toString(),this.newPenalty=parseFloat(this.newPenalty.replace(/,/g,""))):this.newPenalty=0,this.newPrincipal?0==this.newPrincipal?this.newPrincipal=0:(this.newPrincipal=this.newPrincipal.toString(),this.newPrincipal=parseFloat(this.newPrincipal.replace(/,/g,""))):this.newPrincipal=0,this.newServiceCharge?0==this.newServiceCharge?this.newServiceCharge=0:(this.newServiceCharge=this.newServiceCharge.toString(),this.newServiceCharge=parseFloat(this.newServiceCharge.replace(/,/g,""))):this.newServiceCharge=0,this.newInterest=+this.newInterest.toFixed(2),this.newPenalty=+this.newPenalty.toFixed(2),this.newPrincipal=+this.newPrincipal.toFixed(2),this.newServiceCharge=+this.newServiceCharge.toFixed(2);var sum=this.newInterest+this.newPenalty+this.newPrincipal+this.newServiceCharge;if(sum=+sum.toFixed(2),sum!==this.newAmount)return void alert("Please check amount breakdown")}if(isNaN(this.newAmount))return void alert("Invalid amount [Character]");if(parseFloat(this.newAmount)<=0)return void alert("Invalid amount [Negative]");this.lineNo++,this.newLineNo="000"+this.lineNo;var type=this.transaction,drName="",crName="";1==type||3==type||4==type||7==type||9==type?(this.totalDebit+=this.newAmount,this.newDebit=this.newAmount,this.newDebitAccount=this.newAccount,this.totalDebit=+this.totalDebit.toFixed(2),drName="("+$("#glName").val()+")"):(this.totalCredit+=this.newAmount,this.newCredit=this.newAmount,this.newCreditAccount=this.newAccount,this.totalCredit=+this.totalCredit.toFixed(2),crName="("+$("#glName").val()+")"),this.transactions.push({currency:this.newCurrency,account:this.newAccount,amount:this.newAmount,principal:this.newPrincipal,interest:this.newInterest,penalty:this.newPenalty,serviceCharge:this.newServiceCharge,lineNo:this.newLineNo,credit:this.newCredit,debit:this.newDebit,creditAccount:this.newCreditAccount,debitAccount:this.newDebitAccount,transaction:this.transaction,batchId:this.newBatchId,batchName:this.newBatchName,transactionParticulars:this.transactionParticulars,transactionReference:this.transactionReference,checkNo:this.checkNo,glCreditName:""!=this.newCreditAccount?crName:"",glDebitName:""!=this.newDebitAccount?drName:"",glName:$("#glName").val()}),this.newAmount="",this.newPrincipal="",this.newInterest="",this.newPenalty="",this.newServiceCharge="",this.newCreditAccount="",this.newDebitAccount="",this.newCredit="",this.newDebit="",this.breakdown=!1,this.newAccount="",this.transactionReference="",this.transactionParticulars="",$("#account").select2("val",""),$("#transaction").select2("val",""),$("#addNewTransactionModal").modal("hide")},saveTransactions:function(){},saveBatchTransactions:function(e){if(e.preventDefault(),this.transactions.length<=0)return void alert("Add transactions first");if(!this.newBatchName)return void alert("No batch name");{var self=this;this.transaction}self.batchDetails={batchId:self.newBatchId,batchName:self.newBatchName,currency:self.newCurrency,totalDebit:self.totalDebit,totalCredit:self.totalCredit,branch:self.branch,loanAcct:self.newLoans,template:self.newTemplate,valueDate:$("#valueDate").val()},$.ajax("undefined"==typeof batchId?{type:"POST",url:saveBatchTransactionsAjaxLink,data:{transactions:JSON.stringify(self.transactions),batchDetails:JSON.stringify(self.batchDetails)},success:function(){alertify.alert(AppTitle,"Save Successful!",function(){self.transactions=[],self.batchDetails=[],window.location.replace("/icbs/glBatch")})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}}:{type:"POST",url:updateBatchTransactionsAjaxLink,data:{batchId:batchId,transactions:JSON.stringify(self.transactions),batchDetails:JSON.stringify(self.batchDetails)},success:function(){alert("Update Sucessful"),window.location.replace("/icbs/glBatch")},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}})},getAccounts:function(){var type=this.transaction;return console.log("Transaction Type No: "+type),1==type||2==type?1:4==type||5==type||6==type?2:3==type?4:9==type||10==type?9:3},editTransaction:function(transaction){this.transaction=transaction.transaction,this.newAccount=transaction.account,(transaction.principal||transaction.interest||transaction.serviceCharge||transaction.penalty)&&(this.breakdown=!0,this.newPrincipal=transaction.principal,this.newInterest=transaction.interest,this.newPenalty=transaction.penalty,this.newServiceCharge=transaction.serviceCharge),this.newAmount=transaction.amount},clearBreakdown:function(){this.newPrincipal="",this.newInterest="",this.newServiceCharge="",this.newPenalty=""},removeTransaction:function(transaction){null!=transaction.debit&&(this.totalDebit-=transaction.debit),null!=transaction.credit&&(this.totalCredit-=transaction.credit),this.transactions.$remove(transaction)},updateAccounts:function(){var self=this;self.glAccountList=[],self.loanAccountList=[],self.depositAccountList=[],"null"!=self.branch&&($.ajax({type:"GET",url:getGlAccountsAjaxLink,data:{branch_id:this.branch},success:function(data){jQuery.each(data,function(i,val){self.glAccountList.push({text:val.name+" ("+val.code+")",value:val.code})})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}}),$.ajax({type:"GET",url:getDepositAccountsAjaxLink,data:{branch_id:this.branch},success:function(data){jQuery.each(data,function(i,val){self.depositAccountList.push({text:val.acctName+" ("+val.acctNo+")",value:val.acctNo})})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}}),$.ajax({type:"GET",url:getLoanAccountsAjaxLink,data:{branch_id:this.branch},success:function(data){jQuery.each(data,function(i,val){self.loanAccountList.push({text:val.message.accountNo,value:val.message.accountNo})})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}}))},showAddNewTransactionModal:function(){$("#addNewTransactionModal").modal("show")},processBatch:function(batchId){$.ajax({type:"POST",url:processBatchTransactionAjaxLink,data:{batchId:batchId},success:function(data){var status=data.status;"1"==status?notify.message("Batch not yet approved|error|alert"):"2"==status?notify.message("Batch already posted|error|alert"):"3"==status?notify.message("Batch already cancelled|error|alert"):alertify.alert(AppTitle,"Sucess!",function(){location.reload()})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}})},retrieveBatch:function(){var self=this,drName="",crName="";$.ajax({type:"GET",url:getBatchAjaxLink,data:{batchId:batchId},success:function(data){jQuery.each(data,function(i,val){drName="",crName="",1==val.batchType||3==val.batchType||4==val.batchType||7==val.batchType?drName="("+val.accountName+")":crName="("+val.accountName+")",self.transactions.push({lineNo:val.lineNo,debitAccount:val.debitAccount,creditAccount:val.creditAccount,debit:val.debit,credit:val.credit,batchId:val.batchId,amount:val.amount,transaction:val.batchType,transactionParticulars:val.particulars,transactionReference:val.reference,account:val.account,checkNo:val.checkNo,glCreditName:""!=val.creditAccount?crName:"",glDebitName:""!=val.debitAccount?drName:"",glName:val.accountName,principal:val.principal,interest:val.interest,penalty:val.penalty}),self.lineNo=parseInt(val.lineNo)})},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}})},retrieveBatchDetails:function(){var self=this;$.ajax({type:"GET",url:getBatchDetailsAjaxLink,data:{batchId:batchId},success:function(data){self.newBatchId=data.batchDetails.batchId,self.newBatchName=data.batchDetails.batchName,self.totalDebit=data.batchDetails.totalDebit,self.totalCredit=data.batchDetails.totalCredit,self.currency=data.batchDetails.batchCurrency.id,self.branch=data.batchDetails.branch.id,self.newTemplate=data.batchDetails.batchType,$("#valueDate").val(new Date(data.batchDetails.valueDate).toLocaleDateString()),data.loanId&&(self.updateAccounts(),self.newLoans=data.batchDetails.loanId,$("#loans").select2("val",data.batchDetails.loanId)),$("#branch").select2("val",data.batchDetails.branch.id),$("#currency").select2("val",data.batchDetails.batchCurrency.id),$("#template").select2("val",data.batchDetails.batchType)},error:function(XMLHttpRequest,textStatus,errorThrown){alert(XMLHttpRequest+textStatus+errorThrown)}})}},ready:function(){var e=document.createEvent("HTMLEvents");e.initEvent("change",!0,!0),$(this.$el).find("select").select2({width:"resolve"}).on("change",function(){this.dispatchEvent(e)}),"undefined"!=typeof batchId&&(this.retrieveBatchDetails(),this.retrieveBatch(),console.log("done loading values"))}});